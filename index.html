<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kraken Media Slideshow (drag-drop + preview)</title>
<style>
  html,body{height:100%;margin:0}
  body{background:#000;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* ===== Player stage ===== */
  .stage{
    position:relative;width:100vw;height:100vh;overflow:hidden;
    display:flex;align-items:center;justify-content:center;
    background:var(--bg,#000);
  }
  .stage.circle{
    -webkit-mask-image: radial-gradient(circle at 50% 50%, #fff 0 calc(50% - var(--pad,0%)), transparent calc(50% - var(--pad,0%)));
            mask-image: radial-gradient(circle at 50% 50%, #fff 0 calc(50% - var(--pad,0%)), transparent calc(50% - var(--pad,0%)));
  }
  .stage.circle::after{
    content:""; position:absolute; inset:calc(50% - (50% - var(--pad,0%)));
    border-radius:50%;
    border: var(--ringW,0px) solid var(--ringC,#222);
    pointer-events:none;
  }

  .media{position:absolute;inset:0;margin:auto;max-width:100%;max-height:100%;display:none}
  .show{display:block}
  .fade{transition:opacity 300ms ease;opacity:0}
  .fade.show{opacity:1}
  .contain{object-fit:contain}
  .cover{object-fit:cover}

  .media{
    transform-origin:50% 50%;
    transform:
      translate(var(--tx,0%), var(--ty,0%))
      scale(var(--scale,1))
      rotate(var(--rot,0deg));
  }

  /* ===== Configure UI ===== */
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  h1{font-size:1.25rem;margin:0 0 14px}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:1fr 1fr}
  .card{background:#121212;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#0e0e0e;color:#eaeaea}
  textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;background:#6d5ef9;color:#fff;font-weight:700}

  /* Playlist list */
  .list{list-style:none;margin:0;padding:0}
  .item{
    display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;
    background:#0f0f0f;border:1px solid #272727;border-radius:10px;padding:10px;margin:8px 0;
  }
  .grab{cursor:grab;user-select:none;font-weight:700;padding:6px 8px;background:#1b1b1b;border-radius:8px}
  .dragging{opacity:.6}
  .u{width:100%}
  .opt{width:240px}
  .rm{background:#ef4444}
  .muted{color:#aaa;font-size:.9rem}
  .value{min-width:3ch;display:inline-block;text-align:right}

  /* Preview pane inside Configure */
  .previewPane{position:relative;height:380px;background:#000;border-radius:12px;overflow:hidden;display:none}
  .bar{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap}
  .secondary{background:#2b2b2b}
</style>
</head>
<body>

<!-- Player (device or preview) -->
<div id="player" class="stage" style="display:none">
  <img id="imgEl" class="media fade contain" alt="media">
  <video id="vidEl" class="media fade contain" muted playsinline preload="auto"></video>
</div>

<!-- Configure -->
<div id="config" class="wrap" style="display:none">
  <h1>Kraken Media Slideshow — Configure</h1>

  <div class="card">
    <div class="bar">
      <button id="add">Add item</button>
      <button id="importTxt" class="secondary">Import from text</button>
      <button id="exportTxt" class="secondary">Export to text</button>
      <button id="preview" class="secondary">Preview</button>
      <button id="back" class="secondary" style="display:none">Back to editor</button>
      <button id="save">Save</button>
      <button id="load" class="secondary">Load</button>
      <button id="clear" class="secondary">Clear</button>
    </div>
    <div class="muted">Drag the handle to reorder. URL is required. Options are optional JSON for videos or per-image seconds.</div>
    <ul id="list" class="list"></ul>
  </div>

  <div class="card grid cols-2">
    <div>
      <label>Image interval (seconds)</label>
      <input id="interval" type="number" min="1" value="30">
    </div>
    <div>
      <label>Cap video length (seconds, 0 = no cap)</label>
      <input id="videoMax" type="number" min="0" value="0">
    </div>
    <div>
      <label>Object fit</label>
      <select id="fit">
        <option value="contain">contain</option>
        <option value="cover">cover</option>
      </select>
    </div>
    <div>
      <label>Background</label>
      <input id="bg" type="text" value="#000000" placeholder="#000000 or black">
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Circular screen targeting</h3>
    <div class="row">
      <div>
        <label>Shape</label>
        <select id="shape">
          <option value="circle">circle</option>
          <option value="square">square</option>
        </select>
      </div>
      <div>
        <label>Circle padding (%)</label>
        <input id="pad" type="range" min="0" max="20" value="4">
        <div class="muted">Padding: <span id="padVal" class="value">4</span>%</div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Ring border width (px)</label>
        <input id="ringW" type="number" min="0" value="0">
      </div>
      <div>
        <label>Ring border color</label>
        <input id="ringC" type="text" value="#222222">
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Crop and alignment</h3>
    <div class="row">
      <div>
        <label>Zoom</label>
        <input id="scale" type="range" min="100" max="300" value="100">
        <div class="muted">Scale: <span id="scaleVal" class="value">100</span>%</div>
      </div>
      <div>
        <label>Rotation (deg)</label>
        <input id="rot" type="range" min="-180" max="180" value="0">
        <div class="muted"><span id="rotVal" class="value">0</span>°</div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Offset X (%)</label>
        <input id="tx" type="range" min="-50" max="50" value="0">
        <div class="muted"><span id="txVal" class="value">0</span>%</div>
      </div>
      <div>
        <label>Offset Y (%)</label>
        <input id="ty" type="range" min="-50" max="50" value="0">
        <div class="muted"><span id="tyVal" class="value">0</span>%</div>
      </div>
    </div>
  </div>

  <div id="previewPane" class="card previewPane">
    <!-- The same player renders here for live preview -->
    <div id="previewStage" class="stage" style="height:100%">
      <img id="pImg" class="media fade contain" alt="media">
      <video id="pVid" class="media fade contain" muted playsinline preload="auto"></video>
    </div>
  </div>
</div>

<script>
  /* Storage keys */
  const K_PLAYLIST = "krakenPlaylist";
  const K_OPTIONS  = "krakenOptions";

  const isKraken = new URLSearchParams(location.search).get("kraken") === "1";
  document.getElementById(isKraken ? "player" : "config").style.display = isKraken ? "flex" : "block";

  /* ---------- Playlist UI with drag and drop ---------- */
  const listEl = document.getElementById("list");

  function createItem(url="", opt=""){
    const li = document.createElement("li");
    li.className = "item";
    li.draggable = true;
    li.innerHTML = `
      <div class="grab" title="Drag to reorder">☰</div>
      <input class="u" type="text" placeholder="https://example.com/image.webp or video.mp4" value="${url.replace(/"/g,'&quot;')}">
      <div style="display:flex;gap:10px;align-items:center">
        <input class="opt" type="text" placeholder='Optional JSON (e.g. {"seconds":45} or {"loop":true,"maxSeconds":8})' value="${opt.replace(/"/g,'&quot;')}">
        <button class="rm">Remove</button>
      </div>
    `;
    li.querySelector(".rm").addEventListener("click", ()=> li.remove());

    // DnD handlers
    li.addEventListener("dragstart", e=>{
      li.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
    });
    li.addEventListener("dragend", ()=> li.classList.remove("dragging"));
    li.addEventListener("dragover", e=>{
      e.preventDefault();
      const dragging = listEl.querySelector(".dragging");
      if(!dragging || dragging === li) return;
      const rect = li.getBoundingClientRect();
      const before = e.clientY < rect.top + rect.height / 2;
      listEl.insertBefore(dragging, before ? li : li.nextSibling);
    });
    return li;
  }

  function parseLine(url, optStr){
    const isVideo = /\.(mp4|webm)(\?.*)?$/i.test(url);
    const it = { src: url, type: isVideo ? "video" : "image" };
    if (optStr) {
      try { Object.assign(it, JSON.parse(optStr)); } catch {}
    }
    return it;
  }

  function toModel(){
    const items = [];
    for(const li of listEl.querySelectorAll(".item")){
      const url = li.querySelector(".u").value.trim();
      if(!url) continue;
      const opt = li.querySelector(".opt").value.trim();
      items.push(parseLine(url, opt));
    }
    return items;
  }

  function fromModel(items){
    listEl.innerHTML = "";
    for(const it of (items||[])){
      const opts = {};
      if(it.type === "video"){
        if(it.loop) opts.loop = true;
        if(it.maxSeconds) opts.maxSeconds = it.maxSeconds;
      } else if(it.seconds){
        opts.seconds = it.seconds;
      }
      const optStr = Object.keys(opts).length ? JSON.stringify(opts) : "";
      listEl.appendChild(createItem(it.src, optStr));
    }
  }

  function importText(text){
    const lines = (text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const items = [];
    for(const line of lines){
      const m = line.match(/^(\S+)(?:\s+(\{.*\}))?$/);
      if(!m) continue;
      items.push(parseLine(m[1], m[2]||""));
    }
    fromModel(items);
  }

  function exportText(){
    const items = toModel();
    return items.map(it=>{
      const opts = {};
      if(it.type === "video"){
        if(it.loop) opts.loop = true;
        if(it.maxSeconds) opts.maxSeconds = it.maxSeconds;
      } else if(it.seconds){
        opts.seconds = it.seconds;
      }
      const o = Object.keys(opts).length ? " " + JSON.stringify(opts) : "";
      return it.src + o;
    }).join("\n");
  }

  /* ---------- Options form ---------- */
  const els = {
    interval: document.getElementById("interval"),
    videoMax: document.getElementById("videoMax"),
    fit:      document.getElementById("fit"),
    bg:       document.getElementById("bg"),
    shape:    document.getElementById("shape"),
    pad:      document.getElementById("pad"),
    padVal:   document.getElementById("padVal"),
    ringW:    document.getElementById("ringW"),
    ringC:    document.getElementById("ringC"),
    scale:    document.getElementById("scale"),
    scaleVal: document.getElementById("scaleVal"),
    rot:      document.getElementById("rot"),
    rotVal:   document.getElementById("rotVal"),
    tx:       document.getElementById("tx"),
    txVal:    document.getElementById("txVal"),
    ty:       document.getElementById("ty"),
    tyVal:    document.getElementById("tyVal"),
  };
  function readOpts(){
    return {
      interval: Math.max(1, parseInt(els.interval.value||"30",10)),
      videoMax: Math.max(0, parseInt(els.videoMax.value||"0",10)),
      fit: els.fit.value,
      bg:  els.bg.value || "#000000",
      shape: els.shape.value,
      padPct: parseInt(els.pad.value,10),
      ringW: parseInt(els.ringW.value||"0",10),
      ringC: els.ringC.value || "#222222",
      scale: Math.max(0.01, (parseInt(els.scale.value,10)||100) / 100),
      rotDeg: parseInt(els.rot.value,10)||0,
      txPct: parseInt(els.tx.value,10)||0,
      tyPct: parseInt(els.ty.value,10)||0,
    };
  }
  function writeOpts(o){
    els.interval.value = o.interval ?? 30;
    els.videoMax.value = o.videoMax ?? 0;
    els.fit.value      = o.fit || "contain";
    els.bg.value       = o.bg || "#000000";
    els.shape.value    = o.shape || "circle";
    els.pad.value      = o.padPct ?? 4;
    els.ringW.value    = o.ringW ?? 0;
    els.ringC.value    = o.ringC || "#222222";
    els.scale.value    = Math.round((o.scale ?? 1) * 100);
    els.rot.value      = o.rotDeg ?? 0;
    els.tx.value       = o.txPct ?? 0;
    els.ty.value       = o.tyPct ?? 0;
    ["pad","scale","rot","tx","ty"].forEach(updateReadout);
  }
  function updateReadout(id){
    if(typeof id !== "string"){ id = this.id; }
    if(id==="pad") els.padVal.textContent = els.pad.value;
    if(id==="scale") els.scaleVal.textContent = els.scale.value;
    if(id==="rot") els.rotVal.textContent = els.rot.value;
    if(id==="tx") els.txVal.textContent = els.tx.value;
    if(id==="ty") els.tyVal.textContent = els.ty.value;
  }
  ["pad","scale","rot","tx","ty"].forEach(id=>document.getElementById(id).addEventListener("input", updateReadout));

  /* ---------- Load/Save/Clear ---------- */
  function saveToLocal(){
    localStorage.setItem(K_PLAYLIST, JSON.stringify(toModel()));
    localStorage.setItem(K_OPTIONS, JSON.stringify(readOpts()));
    alert("Saved to this PC.");
  }
  function loadFromLocal(){
    const items = JSON.parse(localStorage.getItem(K_PLAYLIST) || "[]");
    const opts  = JSON.parse(localStorage.getItem(K_OPTIONS)  || "{}");
    fromModel(items);
    writeOpts(opts);
    if(!items.length){
      importText(`https://www.gstatic.com/webp/gallery/1.webp
https://media.giphy.com/media/l0HlQ7LRal8X9sWzO/giphy.gif
https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4 {"loop":false,"maxSeconds":6}`);
    }
  }
  function clearAll(){
    localStorage.removeItem(K_PLAYLIST);
    localStorage.removeItem(K_OPTIONS);
    fromModel([]); writeOpts({});
    loadFromLocal();
  }

  /* ---------- Buttons ---------- */
  document.getElementById("add").addEventListener("click", ()=> listEl.appendChild(createItem()));
  document.getElementById("importTxt").addEventListener("click", ()=>{
    const t = prompt("Paste lines: URL [space] optional JSON");
    if(t!=null) importText(t);
  });
  document.getElementById("exportTxt").addEventListener("click", ()=>{
    const t = exportText();
    navigator.clipboard.writeText(t).catch(()=>{});
    alert("Copied playlist text to clipboard.");
  });
  document.getElementById("save").addEventListener("click", saveToLocal);
  document.getElementById("load").addEventListener("click", loadFromLocal);
  document.getElementById("clear").addEventListener("click", clearAll);

  /* ---------- Preview in Configure ---------- */
  const previewBtn = document.getElementById("preview");
  const backBtn = document.getElementById("back");
  const previewPane = document.getElementById("previewPane");
  const pStage = document.getElementById("previewStage");
  const pImg = document.getElementById("pImg");
  const pVid = document.getElementById("pVid");
  let pTimer = null, pIdx = 0;

  function applyVisual(stageEl, imgEl, vidEl, o){
    stageEl.style.setProperty('--bg', o.bg || "#000");
    stageEl.style.setProperty('--pad', (o.padPct||0) + '%');
    stageEl.style.setProperty('--ringW', (o.ringW||0) + 'px');
    stageEl.style.setProperty('--ringC', o.ringC || '#222');
    stageEl.classList.toggle('circle', o.shape === 'circle');
    [imgEl,vidEl].forEach(el=>{
      el.classList.toggle('contain', o.fit === 'contain');
      el.classList.toggle('cover',   o.fit === 'cover');
      el.style.setProperty('--scale', o.scale || 1);
      el.style.setProperty('--rot',   (o.rotDeg||0) + 'deg');
      el.style.setProperty('--tx',    (o.txPct||0) + '%');
      el.style.setProperty('--ty',    (o.tyPct||0) + '%');
    });
  }
  function clearP(){ if(pTimer){ clearTimeout(pTimer); pTimer=null; } }

  function playPreview(items, o){
    applyVisual(pStage, pImg, pVid, o);
    if(!items.length) return;
    function showImage(src, seconds){
      clearP();
      pVid.pause(); pVid.removeAttribute('src'); pVid.load(); pVid.classList.remove('show');
      pImg.src = src; pImg.classList.add('show');
      const s = Math.max(1, seconds || o.interval || 30);
      pTimer = setTimeout(next, s*1000);
    }
    function showVideo(src, entry){
      clearP();
      pImg.classList.remove('show');
      const loop = !!entry.loop;
      const maxSeconds = o.videoMax || entry.maxSeconds || 0;
      pVid.loop = loop && !maxSeconds;
      pVid.muted = true;
      pVid.controls = false;
      pVid.autoplay = true;
      pVid.src = src;
      pVid.classList.add('show');
      const p = pVid.play(); if(p && p.catch) p.catch(()=>setTimeout(()=>pVid.play().catch(()=>{}),250));
      function advance(){ pVid.removeEventListener('ended', advance); next(); }
      if(maxSeconds) pTimer = setTimeout(advance, Math.max(1,maxSeconds)*1000);
      else if(!pVid.loop) pVid.addEventListener('ended', advance, { once:true });
      else if(o.interval) pTimer = setTimeout(advance, Math.max(1,o.interval)*1000);
    }
    function render(){
      const it = items[pIdx]; if(!it) return;
      pImg.classList.remove('fade'); pVid.classList.remove('fade');
      void pImg.offsetWidth; void pVid.offsetWidth;
      pImg.classList.add('fade'); pVid.classList.add('fade');
      if(it.type === 'video') showVideo(it.src, it);
      else showImage(it.src, it.seconds);
    }
    function next(){ pIdx = (pIdx + 1) % items.length; render(); }
    pIdx = 0; render();
  }

  previewBtn.addEventListener("click", ()=>{
    previewPane.style.display = "block";
    backBtn.style.display = "inline-block";
    // Use unsaved form values for live preview
    playPreview(toModel(), readOpts());
  });
  backBtn.addEventListener("click", ()=>{
    previewPane.style.display = "none";
    backBtn.style.display = "none";
    clearP();
  });

  /* ---------- Device playback (kraken=1) ---------- */
  if(isKraken){
    const stage = document.getElementById("player");
    const imgEl = document.getElementById("imgEl");
    const vidEl = document.getElementById("vidEl");

    const items = JSON.parse(localStorage.getItem(K_PLAYLIST) || "[]");
    const o = Object.assign(
      { interval:30, videoMax:0, fit:"contain", bg:"#000000", shape:"circle", padPct:4, ringW:0, ringC:"#222",
        scale:1, rotDeg:0, txPct:0, tyPct:0 },
      JSON.parse(localStorage.getItem(K_OPTIONS) || "{}")
    );

    if(!items.length){
      localStorage.setItem(K_PLAYLIST, JSON.stringify([
        { src:"https://www.gstatic.com/webp/gallery/1.webp", type:"image" },
        { src:"https://media.giphy.com/media/l0HlQ7LRal8X9sWzO/giphy.gif", type:"image" },
        { src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4", type:"video", loop:false }
      ]));
      location.reload();
    }

    stage.style.display = "flex";
    applyVisual(stage, imgEl, vidEl, o);

    let idx=0, timer=null;
    const clearTimer=()=>{ if(timer){ clearTimeout(timer); timer=null; } };

    function showImage(src, seconds){
      clearTimer();
      vidEl.pause(); vidEl.removeAttribute('src'); vidEl.load(); vidEl.classList.remove('show');
      imgEl.src = src; imgEl.classList.add('show');
      const s = Math.max(1, seconds || o.interval || 30);
      timer = setTimeout(next, s*1000);
    }
    function showVideo(src, entry){
      clearTimer();
      imgEl.classList.remove('show');
      const loop = !!entry.loop;
      const maxSeconds = o.videoMax || entry.maxSeconds || 0;

      vidEl.loop = loop && !maxSeconds;
      vidEl.muted = true;
      vidEl.controls = false;
      vidEl.autoplay = true;
      vidEl.src = src;
      vidEl.classList.add('show');
      const p = vidEl.play(); if(p && p.catch) p.catch(()=>setTimeout(()=>vidEl.play().catch(()=>{}),250));

      function advance(){ vidEl.removeEventListener('ended', advance); next(); }
      if(maxSeconds) timer = setTimeout(advance, Math.max(1,maxSeconds)*1000);
      else if(!vidEl.loop) vidEl.addEventListener('ended', advance, { once:true });
      else if(o.interval) timer = setTimeout(advance, Math.max(1,o.interval)*1000);
    }

    function render(){
      const it = items[idx]; if(!it) return;
      imgEl.classList.remove('fade'); vidEl.classList.remove('fade');
      void imgEl.offsetWidth; void vidEl.offsetWidth;
      imgEl.classList.add('fade'); vidEl.classList.add('fade');
      if(it.type === 'video') showVideo(it.src, it);
      else showImage(it.src, it.seconds);
    }
    function next(){ idx = (idx+1) % items.length; render(); }
    render();
  } else {
    // Configure mode startup
    document.getElementById("config").style.display = "block";
    loadFromLocal();
  }
</script>
</body>
</html>
