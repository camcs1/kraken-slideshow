<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kraken Media Slideshow (edit mode + play-once + better object-fit)</title>
<style>
  html,body{height:100%;margin:0}
  body{background:#000;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* ===== Player stage ===== */
  .stage{
    position:relative;width:100vw;height:100vh;overflow:hidden;
    display:flex;align-items:center;justify-content:center;
    background:var(--bg,#000);
  }

  /* IMPORTANT: give <img>/<video> a real box so object-fit works */
  .media{
    position:absolute; inset:0; margin:auto;
    width:100%; height:100%;
    display:none;
    transition:opacity 250ms ease;
    opacity:0;

    transform-origin:50% 50%;
    transform:
      translate(var(--tx,0%), var(--ty,0%))
      scale(var(--scale,1))
      rotate(var(--rot,0deg));
  }
  .show{display:block; opacity:1}
  .contain{object-fit:contain}
  .cover{object-fit:cover}

  /* ===== Configure UI ===== */
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:1.2rem;margin:0 0 14px}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:1fr 1fr}
  .card{background:#121212;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#0e0e0e;color:#eaeaea}
  input[type="checkbox"]{transform:scale(1.2);margin-right:8px}
  textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;background:#6d5ef9;color:#fff;font-weight:700}
  .secondary{background:#2b2b2b}
  .danger{background:#ef4444}
  .muted{color:#aaa;font-size:.9rem}
  .value{min-width:3ch;display:inline-block;text-align:right}

  /* Playlist list */
  .list{list-style:none;margin:0;padding:0}
  .item{
    display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;
    background:#0f0f0f;border:1px solid #272727;border-radius:10px;padding:10px;margin:8px 0;
  }
  .grab{cursor:grab;user-select:none;font-weight:700;padding:6px 8px;background:#1b1b1b;border-radius:8px}
  .dragging{opacity:.6}
  .u{width:100%}
  .opt{width:280px}
  .rm{background:#ef4444}
  .edit{background:#334155}
  .selected{outline:2px solid #6d5ef9}

  /* Inspector */
  .inspector-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#1f2937;font-size:.85rem}

  /* ===== Modal Import ===== */
  .modalOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,.6);
    display:none; align-items:center; justify-content:center; z-index:9999;
  }
  .modal{
    width:min(920px, 92vw); background:#121212; color:#eaeaea;
    border:1px solid #2a2a2a; border-radius:14px; padding:16px;
    box-shadow:0 10px 30px rgba(0,0,0,.5);
  }
  .modal h2{ margin:0 0 10px; font-size:1.1rem; }
  .modal textarea{
    width:100%; min-height:260px; padding:10px; border-radius:10px;
    border:1px solid #333; background:#0e0e0e; color:#eaeaea;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  }
  .modal .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
  .btn{ padding:10px 14px; border:0; border-radius:10px; cursor:pointer; font-weight:700; }
  .btn.primary{ background:#6d5ef9; color:#fff; }
  .btn.secondary{ background:#2b2b2b; color:#eaeaea; }
</style>
</head>
<body>

<!-- Player (device renderer) -->
<div id="player" class="stage" style="display:none">
  <img id="imgEl" class="media contain" alt="media">
  <video id="vidEl" class="media contain" muted playsinline preload="auto"></video>
</div>

<!-- Configure -->
<div id="config" class="wrap" style="display:none">
  <h1>Kraken Media Slideshow — Configure</h1>

  <div class="card">
    <div class="actions">
      <button id="add">Add item</button>
      <button id="importTxt" class="secondary">Import from text</button>
      <button id="exportTxt" class="secondary">Export to text</button>
      <span style="flex:1"></span>
      <button id="editModeBtn" class="secondary" title="Toggle edit mode">Enter Edit Mode</button>
      <button id="save">Save</button>
      <button id="load" class="secondary">Load</button>
      <button id="clear" class="secondary">Clear</button>
    </div>
    <div class="muted">Drag the ☰ handle to reorder. Select a row and tweak settings in the inspector. In <b>Edit Mode</b>, the Kraken shows the selected item live and updates on every change. Press <b>Save</b> to exit Edit Mode and resume the slideshow.</div>
    <ul id="list" class="list"></ul>
  </div>

  <!-- Per-item Inspector -->
  <div class="card" id="inspector" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
      <div>
        <div class="badge"><span id="insType">?</span> <span style="opacity:.7">selected item</span></div>
        <div class="muted" id="insUrl" style="margin-top:6px;word-break:break-all"></div>
      </div>
      <div class="actions">
        <button id="applyItem">Apply to item</button>
        <button id="clearItem" class="danger">Clear item overrides</button>
      </div>
    </div>

    <div class="inspector-grid">
      <div>
        <label>Per-image duration (seconds)</label>
        <input id="i_seconds" type="number" min="0" value="0">
        <div class="muted">For images/GIFs; 0 = use global interval.</div>
      </div>
      <div>
        <label>Video: loop</label>
        <select id="i_loop">
          <option value="inherit">inherit</option>
          <option value="true">true</option>
          <option value="false">false</option>
        </select>
      </div>
      <div>
        <label>Video: max seconds (0 = no cap)</label>
        <input id="i_maxSeconds" type="number" min="0" value="0">
      </div>
      <div>
        <label>Override fit</label>
        <select id="i_fit">
          <option value="inherit">inherit</option>
          <option value="contain">contain</option>
          <option value="cover">cover</option>
        </select>
      </div>
      <div>
        <label>Show at time (HH:MM)</label>
        <input id="i_at" type="time" step="60" value="">
        <div class="muted">24h format; optional.</div>
      </div>
      <div style="grid-column:1/-1;display:flex;align-items:center;margin-top:4px">
        <input id="i_atOnly" type="checkbox">
        <label for="i_atOnly" style="margin:0; font-weight:600">Only at scheduled time</label>
      </div>
      <div style="grid-column:1/-1;display:flex;align-items:center;margin-top:4px">
        <input id="i_playOnce" type="checkbox">
        <label for="i_playOnce" style="margin:0; font-weight:600">Play once</label>
      </div>
    </div>

    <div class="inspector-grid" style="margin-top:12px">
      <div>
        <label>Override zoom (%)</label>
        <input id="i_scale" type="number" min="10" max="500" value="">
        <div class="muted">Blank = inherit global.</div>
      </div>
      <div>
        <label>Override rotation (deg)</label>
        <input id="i_rotDeg" type="number" min="-180" max="180" value="">
      </div>
      <div>
        <label>Override offset X (%)</label>
        <input id="i_txPct" type="number" min="-100" max="100" value="">
      </div>
      <div>
        <label>Override offset Y (%)</label>
        <input id="i_tyPct" type="number" min="-100" max="100" value="">
      </div>
    </div>

    <div class="muted" style="margin-top:10px">
      <b>Play once:</b> Videos advance on <code>ended</code> (loop disabled). GIFs/images show for this item's <b>seconds</b> (or global interval if not set), then advance. Browsers don’t expose a GIF’s intrinsic duration.
    </div>
  </div>

  <!-- Global Options -->
  <div class="card grid cols-2">
    <div>
      <label>Image interval (seconds)</label>
      <input id="interval" type="number" min="1" value="30">
    </div>
    <div>
      <label>Cap video length (seconds, 0 = no cap)</label>
      <input id="videoMax" type="number" min="0" value="0">
    </div>
    <div>
      <label>Object fit</label>
      <select id="fit">
        <option value="contain">contain</option>
        <option value="cover">cover</option>
      </select>
    </div>
    <div>
      <label>Background</label>
      <input id="bg" type="text" value="#000000" placeholder="#000000 or black">
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Global crop and alignment</h3>
    <div class="row">
      <div>
        <label>Zoom</label>
        <input id="scale" type="range" min="100" max="300" value="100">
        <div class="muted">Scale: <span id="scaleVal" class="value">100</span>%</div>
      </div>
      <div>
        <label>Rotation (deg)</label>
        <input id="rot" type="range" min="-180" max="180" value="0">
        <div class="muted"><span id="rotVal" class="value">0</span>°</div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Offset X (%)</label>
        <input id="tx" type="range" min="-50" max="50" value="0">
        <div class="muted"><span id="txVal" class="value">0</span>%</div>
      </div>
      <div>
        <label>Offset Y (%)</label>
        <input id="ty" type="range" min="-50" max="50" value="0">
        <div class="muted"><span id="tyVal" class="value">0</span>%</div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Modal Import dialog ===== -->
<div id="importOverlay" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="importTitle">
  <div class="modal">
    <h2 id="importTitle">Import playlist from text</h2>
    <p class="muted">Paste one item per line. Format: <code>URL</code> or <code>URL {"{...json...}"}</code></p>
    <textarea id="importTextarea" placeholder="https://example.com/a.webp
https://example.com/clip.mp4 {&quot;loop&quot;:true, &quot;maxSeconds&quot;:8}
https://example.com/b.gif {&quot;seconds&quot;:45}"></textarea>
    <div class="actions">
      <button id="importCancel" class="btn secondary">Cancel</button>
      <button id="importDo" class="btn primary">Import</button>
    </div>
  </div>
</div>

<script>
  /* Storage keys + channel */
  const K_PLAYLIST = "krakenPlaylist";
  const K_OPTIONS  = "krakenOptions";
  const K_EDIT     = "krakenEdit";      // messages for edit-mode live preview

  const isKraken = new URLSearchParams(location.search).get("kraken") === "1";
  document.getElementById(isKraken ? "player" : "config").style.display = isKraken ? "flex" : "block";

  /* CAM viewport: lock stage size to device pixels if provided */
  (function lockToDeviceViewport(){
    const nzxt = window.nzxt && window.nzxt.v1;
    if (!nzxt) return; // desktop browser: keep responsive
    const stage = document.getElementById('player');
    if (!stage) return;
    stage.style.width  = nzxt.width  ? nzxt.width + 'px'  : '';
    stage.style.height = nzxt.height ? nzxt.height + 'px' : '';
  })();

  /* ---------- Helper utils ---------- */
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  function inferType(url){ return /\.(mp4|webm)(\?.*)?$/i.test(url) ? "video" : "image"; }
  function parseItem(url, optStr){
    const it = { src:url, type: inferType(url) };
    if (optStr) { try { Object.assign(it, JSON.parse(optStr)); } catch {} }
    return it;
  }
  function itemToOptString(it){
    const o = {};
    if (it.playOnce === true) o.playOnce = true;
    if (it.type === "image" && it.seconds) o.seconds = it.seconds;
    if (it.type === "video"){
      if (typeof it.loop === "boolean") o.loop = it.loop;
      if (it.maxSeconds) o.maxSeconds = it.maxSeconds;
    }
    if (it.fit && it.fit !== "inherit") o.fit = it.fit;
    if (it.at) o.at = it.at;
    if (it.only) o.only = true;
    ["scale","rotDeg","txPct","tyPct"].forEach(k=>{
      if (it[k] !== undefined && it[k] !== null && it[k] !== "") o[k] = it[k];
    });
    return Object.keys(o).length ? JSON.stringify(o) : "";
  }
  function mergeOpts(global, it){
    const o = {...global};
    if (it.fit && it.fit !== "inherit") o.fit = it.fit;
    ["scale","rotDeg","txPct","tyPct"].forEach(k=>{
      if (it[k] !== undefined && it[k] !== null && it[k] !== "") o[k] = it[k];
    });
    return o;
  }
  function applyVisual(stageEl, imgEl, vidEl, o){
    stageEl.style.setProperty('--bg',  o.bg || "#000");
    [imgEl,vidEl].forEach(el=>{
      el.classList.toggle('contain', o.fit === 'contain');
      el.classList.toggle('cover',   o.fit === 'cover');
      el.style.setProperty('--scale', o.scale || 1);
      el.style.setProperty('--rot',   (o.rotDeg||0) + 'deg');
      el.style.setProperty('--tx',    (o.txPct||0) + '%');
      el.style.setProperty('--ty',    (o.tyPct||0) + '%');
    });
  }
  function postEditMessage(msg){
    try { localStorage.setItem(K_EDIT, JSON.stringify({ts:Date.now(), ...msg})); } catch {}
    try { const bc = new BroadcastChannel("krakenChannel"); bc.postMessage({type:"edit", ...msg}); setTimeout(()=>bc.close(),200); } catch {}
  }

  /* ============================================================
     CONFIGURE MODE
  ============================================================ */
  if (!isKraken) {
    const listEl = document.getElementById("list");
    let selectedLi = null;
    let editMode = false;

    /* ---- Playlist rows ---- */
    function createItem(url="", opt=""){
      const li = document.createElement("li");
      li.className = "item";
      li.draggable = true;
      li.innerHTML = `
        <div class="grab" title="Drag to reorder">☰</div>
        <input class="u" type="text" placeholder="https://example.com/image.webp or video.mp4" value="${url.replace(/"/g,'&quot;')}">
        <div style="display:flex;gap:10px;align-items:center">
          <input class="opt" type="text" placeholder='Optional JSON (e.g. {"seconds":45,"playOnce":true})' value="${opt.replace(/"/g,'&quot;')}">
          <button class="edit">Edit</button>
          <button class="rm">Remove</button>
        </div>
      `;

      li.querySelector(".rm").addEventListener("click", ()=>{
        const wasSelected = (selectedLi === li);
        li.remove();
        if (wasSelected) clearInspector();
        if (editMode && wasSelected) maybePreviewSelected();
      });

      li.querySelector(".edit").addEventListener("click", ()=> selectLi(li));

      li.addEventListener("dragstart", e=>{ li.classList.add("dragging"); e.dataTransfer.effectAllowed="move"; });
      li.addEventListener("dragend",   ()=> li.classList.remove("dragging"));
      li.addEventListener("dragover", e=>{
        e.preventDefault();
        const dragging = listEl.querySelector(".dragging");
        if(!dragging || dragging === li) return;
        const rect = li.getBoundingClientRect();
        const before = e.clientY < rect.top + rect.height/2;
        listEl.insertBefore(dragging, before ? li : li.nextSibling);
      });

      li.addEventListener("click", (e)=>{
        if (e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
        selectLi(li);
      });

      li.querySelector(".u").addEventListener("change", ()=>{
        if (li === selectedLi){ loadInspectorFromLi(li); if(editMode) maybePreviewSelected(); }
      });
      li.querySelector(".opt").addEventListener("change", ()=>{
        if (li === selectedLi){ loadInspectorFromLi(li); if(editMode) maybePreviewSelected(); }
      });

      return li;
    }

    function toModel(){
      const items = [];
      for (const li of listEl.querySelectorAll(".item")){
        const url = li.querySelector(".u").value.trim();
        if (!url) continue;
        const it = parseItem(url, li.querySelector(".opt").value.trim());
        items.push(it);
      }
      return items;
    }
    function fromModel(items){
      listEl.innerHTML = "";
      (items||[]).forEach(it=>{
        listEl.appendChild(createItem(it.src, itemToOptString(it)));
      });
    }

    /* ---- Import / Export ---- */
    function importText(text){
      const lines=(text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const items=[];
      for(const line of lines){
        const m = line.match(/^(\S+)(?:\s+(\{.*\}))?$/);
        if(!m) continue;
        items.push(parseItem(m[1], m[2]||""));
      }
      fromModel(items);
      if (editMode && selectedLi) maybePreviewSelected();
    }
    function exportText(){
      return toModel().map(it=>{
        const o = itemToOptString(it);
        return it.src + (o ? " " + o : "");
      }).join("\n");
    }

    /* ---- Globals form ---- */
    const els = {
      interval: document.getElementById("interval"),
      videoMax: document.getElementById("videoMax"),
      fit:      document.getElementById("fit"),
      bg:       document.getElementById("bg"),
      scale:    document.getElementById("scale"),
      scaleVal: document.getElementById("scaleVal"),
      rot:      document.getElementById("rot"),
      rotVal:   document.getElementById("rotVal"),
      tx:       document.getElementById("tx"),
      txVal:    document.getElementById("txVal"),
      ty:       document.getElementById("ty"),
      tyVal:    document.getElementById("tyVal"),
    };
    ["scale","rot","tx","ty"].forEach(id=>{
      document.getElementById(id).addEventListener("input", ()=>{
        if(id==="scale") els.scaleVal.textContent = els.scale.value;
        if(id==="rot") els.rotVal.textContent = els.rot.value;
        if(id==="tx") els.txVal.textContent = els.tx.value;
        if(id==="ty") els.tyVal.textContent = els.ty.value;
        if (editMode) maybePreviewSelected();
      });
    });
    ["interval","videoMax","fit","bg"].forEach(id=>{
      document.getElementById(id).addEventListener("change", ()=>{
        if (editMode) maybePreviewSelected();
      });
    });

    function readGlobals(){
      return {
        interval: Math.max(1, parseInt(els.interval.value||"30",10)),
        videoMax: Math.max(0, parseInt(els.videoMax.value||"0",10)),
        fit: els.fit.value,
        bg:  els.bg.value || "#000000",
        scale: Math.max(0.01, (parseInt(els.scale.value,10)||100) / 100),
        rotDeg: parseInt(els.rot.value,10)||0,
        txPct: parseInt(els.tx.value,10)||0,
        tyPct: parseInt(els.ty.value,10)||0,
      };
    }
    function writeGlobals(o){
      els.interval.value = o.interval ?? 30;
      els.videoMax.value = o.videoMax ?? 0;
      els.fit.value      = o.fit || "contain";
      els.bg.value       = o.bg || "#000000";
      els.scale.value    = Math.round((o.scale ?? 1) * 100); els.scaleVal.textContent = els.scale.value;
      els.rot.value      = o.rotDeg ?? 0; els.rotVal.textContent = els.rot.value;
      els.tx.value       = o.txPct ?? 0;  els.txVal.textContent = els.tx.value;
      els.ty.value       = o.tyPct ?? 0;  els.tyVal.textContent = els.ty.value;
    }

    /* ---- Persistence ---- */
    function saveToLocal(){
      localStorage.setItem(K_PLAYLIST, JSON.stringify(toModel()));
      localStorage.setItem(K_OPTIONS, JSON.stringify(readGlobals()));
      // Exit edit mode and tell device to resume slideshow
      if (editMode) toggleEditMode(false, true);
      else alert("Saved to this PC.");
    }
    function loadFromLocal(){
      const items = JSON.parse(localStorage.getItem(K_PLAYLIST) || "[]");
      const opts  = JSON.parse(localStorage.getItem(K_OPTIONS)  || "{}");
      fromModel(items);
      writeGlobals(opts);
      if(!items.length){
        fromModel([
          { src:"https://www.gstatic.com/webp/gallery/1.webp", type:"image" },
          { src:"https://media.giphy.com/media/l0HlQ7LRal8X9sWzO/giphy.gif", type:"image", seconds:8, playOnce:true },
          { src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4", type:"video", loop:false, playOnce:true }
        ]);
      }
    }
    function clearAll(){
      localStorage.removeItem(K_PLAYLIST);
      localStorage.removeItem(K_OPTIONS);
      fromModel([]); writeGlobals({});
      loadFromLocal();
    }

    /* ---- Buttons ---- */
    document.getElementById("add").addEventListener("click", ()=>{
      const li = createItem();
      listEl.appendChild(li);
      // Auto-select the new row
      selectLi(li);
      if (editMode) maybePreviewSelected();
    });
    document.getElementById("exportTxt").addEventListener("click", ()=>{
      const t = exportText();
      navigator.clipboard.writeText(t).catch(()=>{});
      alert("Copied playlist text to clipboard.");
    });
    document.getElementById("save").addEventListener("click", saveToLocal);
    document.getElementById("load").addEventListener("click", loadFromLocal);
    document.getElementById("clear").addEventListener("click", clearAll);

    /* ---- Import modal wiring ---- */
    const importBtn = document.getElementById("importTxt");
    const importOverlay = document.getElementById("importOverlay");
    const importTextarea = document.getElementById("importTextarea");
    const importDo = document.getElementById("importDo");
    const importCancel = document.getElementById("importCancel");
    function openImport(text=""){ importTextarea.value = text || ""; importOverlay.style.display = "flex"; setTimeout(()=>importTextarea.focus(), 0); }
    function closeImport(){ importOverlay.style.display = "none"; }
    function doImport(){ const t = importTextarea.value.trim(); if (!t) { closeImport(); return; } importText(t); closeImport(); }
    importBtn.addEventListener("click", ()=> openImport());
    importDo.addEventListener("click", doImport);
    importCancel.addEventListener("click", closeImport);
    importOverlay.addEventListener("click", (e)=>{ if (e.target === importOverlay) closeImport(); });
    importTextarea.addEventListener("keydown", (e)=>{
      if (e.key === "Escape") { e.preventDefault(); closeImport(); }
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") { e.preventDefault(); doImport(); }
    });

    /* --------- Per-item Inspector --------- */
    const ins = {
      root: document.getElementById("inspector"),
      type: document.getElementById("insType"),
      url:  document.getElementById("insUrl"),
      apply: document.getElementById("applyItem"),
      clear: document.getElementById("clearItem"),
      seconds: document.getElementById("i_seconds"),
      loop:    document.getElementById("i_loop"),
      maxSeconds: document.getElementById("i_maxSeconds"),
      fit:     document.getElementById("i_fit"),
      at:      document.getElementById("i_at"),
      atOnly:  document.getElementById("i_atOnly"),
      playOnce:document.getElementById("i_playOnce"),
      scale:   document.getElementById("i_scale"),
      rotDeg:  document.getElementById("i_rotDeg"),
      txPct:   document.getElementById("i_txPct"),
      tyPct:   document.getElementById("i_tyPct"),
    };

    function clearInspector(){
      if (selectedLi) selectedLi.classList.remove("selected");
      selectedLi = null;
      ins.root.style.display = "none";
      if (editMode) maybePreviewSelected(); // clears preview
    }
    function loadInspectorFromLi(li){
      const url = li.querySelector(".u").value.trim();
      const raw = li.querySelector(".opt").value.trim();
      const it  = parseItem(url, raw);
      ins.type.textContent = (it.type || inferType(url)).toUpperCase();
      ins.url.textContent = url || "(no url)";
      ins.seconds.value   = it.type==="image" ? (it.seconds||0) : 0;
      ins.loop.value      = (typeof it.loop === "boolean") ? String(it.loop) : "inherit";
      ins.maxSeconds.value= it.maxSeconds || 0;
      ins.fit.value       = it.fit ? it.fit : "inherit";
      ins.at.value        = it.at || "";
      ins.atOnly.checked  = !!it.only;
      ins.playOnce.checked= !!it.playOnce;
      ins.scale.value     = (it.scale!=null) ? Math.round(it.scale*100) : "";
      ins.rotDeg.value    = (it.rotDeg!=null) ? it.rotDeg : "";
      ins.txPct.value     = (it.txPct!=null) ? it.txPct : "";
      ins.tyPct.value     = (it.tyPct!=null) ? it.tyPct : "";
    }
    function writeLiFromInspector(li){
      const url = li.querySelector(".u").value.trim();
      if (!url) return alert("URL is required for this item.");
      const type = inferType(url);
      const it = parseItem(url, li.querySelector(".opt").value.trim());
      it.type = type;

      // playOnce for both images and videos
      if (ins.playOnce.checked) it.playOnce = true; else delete it.playOnce;

      const seconds = parseInt(ins.seconds.value||"0",10);
      if (type==="image"){
        if (seconds>0) it.seconds = seconds; else delete it.seconds;
      } else { delete it.seconds; }

      if (type==="video"){
        const ms = parseInt(ins.maxSeconds.value||"0",10);
        if (ms>0) it.maxSeconds = ms; else delete it.maxSeconds;
        if (ins.loop.value==="true") it.loop = true;
        else if (ins.loop.value==="false") it.loop = false;
        else delete it.loop;
      } else { delete it.loop; delete it.maxSeconds; }

      const fit = ins.fit.value;
      if (fit==="contain" || fit==="cover") it.fit = fit; else delete it.fit;

      const at = ins.at.value.trim();
      if (at) it.at = at; else delete it.at;
      if (ins.atOnly.checked) it.only = true; else delete it.only;

      const s = ins.scale.value.trim();
      if (s!==""){ it.scale = clamp(parseInt(s,10)/100, 0.01, 5); } else delete it.scale;
      ["rotDeg","txPct","tyPct"].forEach(k=>{
        const v = ins[k].value.trim();
        if (v!=="") it[k] = parseInt(v,10); else delete it[k];
      });

      li.querySelector(".opt").value = itemToOptString(it);
    }
    function selectLi(li){
      if (selectedLi) selectedLi.classList.remove("selected");
      selectedLi = li;
      li.classList.add("selected");
      ins.root.style.display = "block";
      loadInspectorFromLi(li);
      if (editMode) maybePreviewSelected();
    }

    function getSelectedItemAndOptions(){
      if (!selectedLi) return null;
      const url = selectedLi.querySelector(".u").value.trim();
      if (!url) return null;
      const it = parseItem(url, selectedLi.querySelector(".opt").value.trim());
      const opts = readGlobals();
      return { it, opts: mergeOpts(opts, it) };
    }

    function maybePreviewSelected(){
      const data = getSelectedItemAndOptions();
      if (!editMode || !data) { postEditMessage({ action:"update", item:null }); return; }
      postEditMessage({ action:"update", item:data.it, options:data.opts });
    }

    // apply/clear buttons
    ins.apply.addEventListener("click", ()=>{
      if (!selectedLi) return;
      writeLiFromInspector(selectedLi);
      loadInspectorFromLi(selectedLi);
      if (editMode) maybePreviewSelected();
    });
    ins.clear.addEventListener("click", ()=>{
      if (!selectedLi) return;
      selectedLi.querySelector(".opt").value = "";
      loadInspectorFromLi(selectedLi);
      if (editMode) maybePreviewSelected();
    });

    /* ---- Edit mode toggle ---- */
    const editBtn = document.getElementById("editModeBtn");
    function toggleEditMode(on, fromSave=false){
      editMode = on;
      editBtn.textContent = on ? "Exit Edit Mode" : "Enter Edit Mode";
      if (on){
        const data = getSelectedItemAndOptions();
        postEditMessage({ action:"start", item: data?.it || null, options: data?.opts || readGlobals() });
        if (data) postEditMessage({ action:"update", item:data.it, options:data.opts });
      } else {
        postEditMessage({ action:"end" });
        if (fromSave) alert("Saved and exited Edit Mode.");
      }
    }
    editBtn.addEventListener("click", ()=> toggleEditMode(!editMode));

    /* Init Configure mode */
    document.getElementById("config").style.display = "block";
    loadFromLocal();
  }

  /* ============================================================
     DEVICE MODE (kraken=1) — plays saved playlist, supports edit mode live preview
  ============================================================ */
  if (isKraken) {
    const stage = document.getElementById("player");
    const imgEl = document.getElementById("imgEl");
    const vidEl = document.getElementById("vidEl");
    stage.style.display = "flex";

    let items = JSON.parse(localStorage.getItem(K_PLAYLIST) || "[]");
    let o = Object.assign(
      { interval:30, videoMax:0, fit:"contain", bg:"#000000",
        scale:1, rotDeg:0, txPct:0, tyPct:0 },
      JSON.parse(localStorage.getItem(K_OPTIONS) || "{}")
    );

    if(!items.length){
      localStorage.setItem(K_PLAYLIST, JSON.stringify([
        { src:"https://www.gstatic.com/webp/gallery/1.webp", type:"image" },
        { src:"https://media.giphy.com/media/l0HlQ7LRal8X9sWzO/giphy.gif", type:"image", seconds:8, playOnce:true },
        { src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4", type:"video", loop:false, playOnce:true }
      ]));
      location.reload();
    }

    let idx=0, timer=null;
    let editMode=false;        // if true, freeze slideshow timers
    let lastMsgTs=0;

    function resetIndex(){
      const i = items.findIndex(it => !(it.at && it.only));
      idx = i === -1 ? 0 : i;
    }
    resetIndex();

    const scheduleShown = {};
    function checkSchedule(){
      if(editMode) return;
      const now = new Date();
      const time = now.toTimeString().slice(0,5);
      const day = now.toDateString();
      if (scheduleShown[time] === day) return;
      const found = items.findIndex(it => (it.at && it.at.padStart(5,'0') === time));
      if (found !== -1){
        scheduleShown[time] = day;
        idx = found;
        render();
      }
    }
    setInterval(checkSchedule, 1000);

    const clearTimer=()=>{ if(timer){ clearTimeout(timer); timer=null; } };

    function showImage(src, seconds, entry, opts, advance=true){
      clearTimer();
      applyVisual(stage, imgEl, vidEl, opts || o);
      vidEl.pause(); vidEl.removeAttribute('src'); vidEl.load(); vidEl.classList.remove('show');
      imgEl.src = src; imgEl.classList.add('show');

      if (!editMode && advance){
        // If playOnce is requested for images/GIFs, we rely on per-item seconds or global interval
        const base = Math.max(1, seconds || (opts?.interval ?? o.interval) || 30);
        const s = entry?.playOnce ? base : base; // same timing, semantics differ
        timer = setTimeout(next, s*1000);
      }
    }

    function showVideo(src, entry, opts, advance=true){
      clearTimer();
      applyVisual(stage, imgEl, vidEl, opts || o);
      imgEl.classList.remove('show');

      const playOnce = !!entry.playOnce;
      const maxSeconds = (opts?.videoMax || 0) || entry.maxSeconds || 0;
      const loop = playOnce ? false : (entry.loop===true) && !maxSeconds;

      vidEl.loop = loop;
      vidEl.muted = true;
      vidEl.controls = false;
      vidEl.autoplay = true;
      vidEl.src = src;
      vidEl.classList.add('show');

      const p = vidEl.play(); if(p && p.catch) p.catch(()=>setTimeout(()=>vidEl.play().catch(()=>{}),250));

      function advanceNow(){ vidEl.removeEventListener('ended', advanceNow); next(); }

      if (!editMode && advance){
        if (playOnce){
          // advance exactly when the video ends
          vidEl.addEventListener('ended', advanceNow, { once:true });
          if (maxSeconds) timer = setTimeout(advanceNow, Math.max(1,maxSeconds)*1000);
        } else if (maxSeconds){
          timer = setTimeout(advanceNow, Math.max(1,maxSeconds)*1000);
        } else if (!vidEl.loop){
          vidEl.addEventListener('ended', advanceNow, { once:true });
        } else if (opts?.interval || o.interval){
          timer = setTimeout(advanceNow, Math.max(1,(opts?.interval||o.interval))*1000);
        }
      }
    }

    function render(){
      const it = items[idx]; if(!it) return;
      const eff = mergeOpts(o, it);
      imgEl.classList.remove('fade'); vidEl.classList.remove('fade');
      void imgEl.offsetWidth; void vidEl.offsetWidth;
      imgEl.classList.add('fade'); vidEl.classList.add('fade');
      if(it.type === 'video') showVideo(it.src, it, eff);
      else showImage(it.src, it.seconds, it, eff);
    }
    function next(){
        if (!items.length) return;
        let start = idx;
        do {
          idx = (idx + 1) % items.length;
          if (!(items[idx].at && items[idx].only)) {
            render();
            return;
          }
        } while (idx !== start);
        imgEl.classList.remove('show');
        vidEl.classList.remove('show');
    }

    if (!(items[idx] && items[idx].at && items[idx].only)) render();

    /* ---- Respond to edit-mode messages ---- */
    function handleEditMessage(msg){
      if (!msg || !msg.action) return;
      if (msg.ts && msg.ts <= lastMsgTs) return;
      lastMsgTs = msg.ts || Date.now();

      if (msg.action === "start"){
        editMode = true;
        clearTimer();
        if (msg.options) o = Object.assign({}, o, msg.options);
        if (msg.item){
          const it = msg.item;
          const opts = msg.options || o;
          if (inferType(it.src) === "video") showVideo(it.src, it, opts, false);
          else showImage(it.src, it.seconds, it, opts, false);
        }
      }
      else if (msg.action === "update"){
        editMode = true;
        clearTimer();
        if (!msg.item) return; // no selection
        const it = msg.item;
        const opts = msg.options || o;
        imgEl.classList.remove('fade'); vidEl.classList.remove('fade');
        void imgEl.offsetWidth; void vidEl.offsetWidth;
        imgEl.classList.add('fade'); vidEl.classList.add('fade');
        if (inferType(it.src) === "video") showVideo(it.src, it, opts, false);
        else showImage(it.src, it.seconds, it, opts, false);
      }
      else if (msg.action === "end"){
        // Exit edit mode and resume slideshow using latest saved playlist/options
        editMode = false;
        o = Object.assign(
          { interval:30, videoMax:0, fit:"contain", bg:"#000000",
            scale:1, rotDeg:0, txPct:0, tyPct:0 },
          JSON.parse(localStorage.getItem(K_OPTIONS) || "{}")
        );
        items = JSON.parse(localStorage.getItem(K_PLAYLIST) || "[]") || items;
        resetIndex();
        clearTimer();
        if (!(items[idx] && items[idx].at && items[idx].only)) render();
      }
    }

    window.addEventListener("storage", (e)=>{
      if (e.key === K_EDIT && e.newValue){
        try { handleEditMessage(JSON.parse(e.newValue)); } catch {}
      }
      if (!editMode && e.key === K_OPTIONS) {
        o = Object.assign(
          { interval:30, videoMax:0, fit:"contain", bg:"#000000",
            scale:1, rotDeg:0, txPct:0, tyPct:0 },
          JSON.parse(localStorage.getItem(K_OPTIONS) || "{}")
        );
      }
        if (!editMode && e.key === K_PLAYLIST) {
          items = JSON.parse(localStorage.getItem(K_PLAYLIST) || "[]") || items;
          resetIndex();
        }
    });

    try {
      const bc = new BroadcastChannel("krakenChannel");
      bc.onmessage = (ev)=>{
        if (ev?.data?.type === "edit") handleEditMessage({ ts:Date.now(), ...ev.data });
      };
    } catch {}
  }
</script>
</body>
</html>
