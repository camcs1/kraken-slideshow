<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kraken Media Slideshow (Edit mode live preview)</title>
<style>
  html,body{height:100%;margin:0}
  body{background:#000;color:#eaeaea;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* ===== Player stage + device box ===== */
  .stage{position:relative;width:100vw;height:100vh;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--bg,#000)}
  .deviceBox{width:var(--boxPx,640px);height:var(--boxPx,640px);position:relative;transform-origin:50% 50%;transform:scale(var(--boxScale,1))}
  .deviceBox.circle{
    -webkit-mask-image:radial-gradient(circle at 50% 50%,#fff 0 calc(50% - var(--pad,0%)),transparent calc(50% - var(--pad,0%)));
            mask-image:radial-gradient(circle at 50% 50%,#fff 0 calc(50% - var(--pad,0%)),transparent calc(50% - var(--pad,0%)));
  }
  .deviceBox.circle::after{content:"";position:absolute;inset:calc(50% - (50% - var(--pad,0%)));border-radius:50%;border:var(--ringW,0px) solid var(--ringC,#222);pointer-events:none}

  .media{position:absolute;inset:0;margin:auto;max-width:100%;max-height:100%;display:none;transform-origin:50% 50%}
  .show{display:block}
  .fade{transition:opacity 300ms ease;opacity:0}
  .fade.show{opacity:1}
  .contain{object-fit:contain}
  .cover{object-fit:cover}
  .media{transform:translate(var(--tx,0%),var(--ty,0%)) scale(var(--scale,1)) rotate(var(--rot,0deg))}

  /* ===== Configure UI ===== */
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{font-size:1.25rem;margin:0 0 14px}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:1fr 1fr}
  .card{background:#121212;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25);margin-bottom:14px}
  label{display:block;margin:8px 0 6px;font-weight:600}
  input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#0e0e0e;color:#eaeaea}
  textarea{min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  button{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;background:#6d5ef9;color:#fff;font-weight:700}
  .secondary{background:#2b2b2b}
  .danger{background:#ef4444}
  .muted{color:#aaa;font-size:.9rem}
  .value{min-width:3ch;display:inline-block;text-align:right}

  /* Playlist list */
  .list{list-style:none;margin:0;padding:0}
  .item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;background:#0f0f0f;border:1px solid #272727;border-radius:10px;padding:10px;margin:8px 0}
  .grab{cursor:grab;user-select:none;font-weight:700;padding:6px 8px;background:#1b1b1b;border-radius:8px}
  .dragging{opacity:.6}
  .u{width:100%}
  .opt{width:260px}
  .rm{background:#ef4444}
  .prev{background:#10b981}
  .edit{background:#334155}
  .selected{outline:2px solid #6d5ef9}

  /* Import modal */
  .modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center;padding:16px}
  .modal.show{display:flex}
  .modal .panel{width:min(900px,96vw);background:#0f0f10;border:1px solid #2a2a2a;border-radius:12px;padding:16px;box-shadow:0 12px 40px rgba(0,0,0,.5)}
  .modal .panel h2{margin:0 0 10px;font-size:1.1rem}
  .modal .panel .btns{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
</style>
</head>
<body>

<!-- Player (device renderer) -->
<div id="player" class="stage" style="display:none">
  <div id="box" class="deviceBox">
    <img id="imgEl" class="media fade contain" alt="media">
    <video id="vidEl" class="media fade contain" muted playsinline preload="auto"></video>
  </div>
</div>

<!-- Configure -->
<div id="config" class="wrap" style="display:none">
  <h1>Kraken Media Slideshow — Configure</h1>

  <div class="card">
    <div class="actions" style="gap:10px;flex-wrap:wrap">
      <button id="add">Add item</button>
      <button id="importTxt" class="secondary">Import from text</button>
      <button id="exportTxt" class="secondary">Export to text</button>
      <label style="display:flex;align-items:center;gap:8px;margin-left:auto">
        <input id="editMode" type="checkbox"> Edit mode (live preview)
      </label>
      <button id="save">Save</button>
      <button id="load" class="secondary">Load</button>
      <button id="clear" class="secondary">Clear</button>
    </div>
    <div class="muted">Drag the ☰ handle to reorder. <b>Edit mode</b>: selecting or changing a row instantly previews it on the device.</div>
    <ul id="list" class="list"></ul>
  </div>

  <!-- Per-item Inspector -->
  <div class="card" id="inspector" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
      <div class="muted" id="insUrl" style="word-break:break-all"></div>
      <div class="actions">
        <button id="applyItem">Apply to item</button>
        <button id="previewItem" class="secondary">Preview (once)</button>
        <button id="clearItem" class="danger">Clear item overrides</button>
      </div>
    </div>

    <div class="grid cols-2">
      <div>
        <label>Per-image duration (seconds)</label>
        <input id="i_seconds" type="number" min="0" value="0">
        <div class="muted">0 = use global interval (images only).</div>
      </div>
      <div>
        <label>Video loop</label>
        <select id="i_loop">
          <option value="inherit">inherit</option>
          <option value="true">true</option>
          <option value="false">false</option>
        </select>
      </div>
      <div>
        <label>Video max seconds (0 = no cap)</label>
        <input id="i_maxSeconds" type="number" min="0" value="0">
      </div>
      <div>
        <label>Override fit</label>
        <select id="i_fit">
          <option value="inherit">inherit</option>
          <option value="contain">contain</option>
          <option value="cover">cover</option>
        </select>
      </div>
      <div>
        <label>Override zoom (%)</label>
        <input id="i_scale" type="number" min="10" max="500" value="">
      </div>
      <div>
        <label>Override rotation (deg)</label>
        <input id="i_rotDeg" type="number" min="-180" max="180" value="">
      </div>
      <div>
        <label>Override offset X (%)</label>
        <input id="i_txPct" type="number" min="-100" max="100" value="">
      </div>
      <div>
        <label>Override offset Y (%)</label>
        <input id="i_tyPct" type="number" min="-100" max="100" value="">
      </div>
    </div>
  </div>

  <!-- Global Options -->
  <div class="card grid cols-2">
    <div>
      <label>Image interval (seconds)</label>
      <input id="interval" type="number" min="1" value="30">
    </div>
    <div>
      <label>Cap video length (seconds, 0 = no cap)</label>
      <input id="videoMax" type="number" min="0" value="0">
    </div>
    <div>
      <label>Object fit</label>
      <select id="fit">
        <option value="contain">contain</option>
        <option value="cover">cover</option>
      </select>
    </div>
    <div>
      <label>Background</label>
      <input id="bg" type="text" value="#000000" placeholder="#000000 or black">
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Circular screen & device box</h3>
    <div class="row">
      <div>
        <label>Shape</label>
        <select id="shape">
          <option value="circle">circle</option>
          <option value="square">square</option>
        </select>
      </div>
      <div>
        <label>Circle padding (%)</label>
        <input id="pad" type="range" min="0" max="20" value="4">
        <div class="muted">Padding: <span id="padVal" class="value">4</span>%</div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Ring border width (px)</label>
        <input id="ringW" type="number" min="0" value="0">
      </div>
      <div>
        <label>Ring border color</label>
        <input id="ringC" type="text" value="#222222">
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label><input id="useBox" type="checkbox" checked> Emulate device box</label>
        <div class="muted">Kraken Elite 2024 RGB: 640×640.</div>
      </div>
      <div>
        <label>Box size (px)</label>
        <input id="boxPx" type="number" min="100" max="2000" value="640">
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Compensation (%)</label>
        <input id="boxComp" type="range" min="50" max="200" value="100">
        <div class="muted">If CAM scales oddly, tweak. 100% = neutral.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">Global crop & alignment</h3>
    <div class="row">
      <div>
        <label>Zoom</label>
        <input id="scale" type="range" min="100" max="300" value="100">
        <div class="muted">Scale: <span id="scaleVal" class="value">100</span>%</div>
      </div>
      <div>
        <label>Rotation (deg)</label>
        <input id="rot" type="range" min="-180" max="180" value="0">
        <div class="muted"><span id="rotVal" class="value">0</span>°</div>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <div>
        <label>Offset X (%)</label>
        <input id="tx" type="range" min="-50" max="50" value="0">
        <div class="muted"><span id="txVal" class="value">0</span>%</div>
      </div>
      <div>
        <label>Offset Y (%)</label>
        <input id="ty" type="range" min="-50" max="50" value="0">
        <div class="muted"><span id="tyVal" class="value">0</span>%</div>
      </div>
    </div>
  </div>
</div>

<!-- Import modal -->
<div id="importModal" class="modal" aria-modal="true" role="dialog">
  <div class="panel">
    <h2>Import playlist from text</h2>
    <p class="muted">One entry per line: <code>URL</code> optionally followed by JSON (e.g. <code>{"seconds":45}</code> or <code>{"fit":"cover","scale":2}</code>).</p>
    <textarea id="importText" style="width:100%;min-height:260px"></textarea>
    <div class="btns">
      <button id="importParse">Import</button>
      <button id="importCancel" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ===== Keys & mode ===== */
const K_PLAYLIST="krakenPlaylist", K_OPTIONS="krakenOptions", K_PREVIEW="krakenPreview", K_CMD="krakenCmd";
const isKraken = new URLSearchParams(location.search).get("kraken")==="1";
document.getElementById(isKraken?"player":"config").style.display = isKraken?"flex":"block";

/* ===== Shared helpers ===== */
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const inferType=url=>/\.(mp4|webm)(\?.*)?$/i.test(url)?"video":"image";
function parseItem(url, optStr){ const it={src:url,type:inferType(url)}; if(optStr){try{Object.assign(it,JSON.parse(optStr))}catch{}} return it; }
function itemToOptString(it){ const o={}; if(it.type==="image"&&it.seconds)o.seconds=it.seconds; if(it.type==="video"){if(typeof it.loop==="boolean")o.loop=it.loop; if(it.maxSeconds)o.maxSeconds=it.maxSeconds;} if(it.fit&&it.fit!=="inherit")o.fit=it.fit; ["scale","rotDeg","txPct","tyPct"].forEach(k=>{if(it[k]!=null&&it[k]!=="")o[k]=it[k]}); return Object.keys(o).length?JSON.stringify(o):""; }
function mergeOpts(global,it){ const o={...global}; if(it.fit&&it.fit!=="inherit")o.fit=it.fit; ["scale","rotDeg","txPct","tyPct"].forEach(k=>{if(it[k]!=null&&it[k]!=="")o[k]=it[k]}); return o; }
function applyVisual(boxEl,imgEl,vidEl,o){ boxEl.style.setProperty('--pad',(o.padPct||0)+'%'); boxEl.style.setProperty('--ringW',(o.ringW||0)+'px'); boxEl.style.setProperty('--ringC',o.ringC||'#222'); boxEl.classList.toggle('circle',o.shape==='circle'); [imgEl,vidEl].forEach(el=>{ el.classList.toggle('contain',o.fit==='contain'); el.classList.toggle('cover',o.fit==='cover'); el.style.setProperty('--scale',o.scale||1); el.style.setProperty('--rot',(o.rotDeg||0)+'deg'); el.style.setProperty('--tx',(o.txPct||0)+'%'); el.style.setProperty('--ty',(o.tyPct||0)+'%'); }); }

/* =================================================================
   CONFIGURE MODE
================================================================= */
if(!isKraken){
  const listEl=document.getElementById("list");
  const editModeEl=document.getElementById("editMode");
  let selectedLi=null;

  const importModal=document.getElementById("importModal");
  const importText=document.getElementById("importText");
  document.getElementById("importTxt").addEventListener("click",()=>{importText.value="";importModal.classList.add("show")});
  document.getElementById("importCancel").addEventListener("click",()=>importModal.classList.remove("show"));
  document.getElementById("importParse").addEventListener("click",()=>{
    const t=importText.value;
    if(t&&t.trim()){
      const items=[]; t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).forEach(line=>{
        const m=line.match(/^(\S+)(?:\s+(\{.*\}))?$/); if(m) items.push(parseItem(m[1],m[2]||""));
      });
      fromModel(items);
    }
    importModal.classList.remove("show");
  });

  function createItem(url="",opt=""){
    const li=document.createElement("li"); li.className="item"; li.draggable=true;
    li.innerHTML=`
      <div class="grab" title="Drag to reorder">☰</div>
      <input class="u" type="text" placeholder="https://example.com/image.webp or video.mp4" value="${url.replace(/"/g,'&quot;')}">
      <div style="display:flex;gap:10px;align-items:center">
        <input class="opt" type="text" placeholder='Optional JSON (e.g. {"seconds":45} or {"fit":"cover","scale":2})' value="${opt.replace(/"/g,'&quot;')}">
        <button class="edit">Edit</button>
        <button class="prev">Preview</button>
        <button class="rm">Remove</button>
      </div>`;
    li.querySelector(".rm").addEventListener("click",()=>{ if(selectedLi===li) clearInspector(); li.remove(); maybeAutoPreviewOnSelect(null); });
    li.querySelector(".edit").addEventListener("click",()=> selectLi(li));
    li.addEventListener("click",(e)=>{ if(e.target.tagName!=="INPUT"&&e.target.tagName!=="BUTTON") selectLi(li); });

    // live preview on URL/options change when in edit mode (debounced)
    const debouncedChange=debounce(()=>{ if(editModeEl.checked && selectedLi===li) sendLivePreviewForLi(li); }, 200);
    li.querySelector(".u").addEventListener("input",debouncedChange);
    li.querySelector(".opt").addEventListener("input",debouncedChange);

    // one-shot Preview
    li.querySelector(".prev").addEventListener("click",()=> sendPreviewForLi(li));

    // DnD
    li.addEventListener("dragstart",e=>{li.classList.add("dragging");e.dataTransfer.effectAllowed="move"});
    li.addEventListener("dragend",()=>li.classList.remove("dragging"));
    li.addEventListener("dragover",e=>{
      e.preventDefault();
      const dragging=listEl.querySelector(".dragging"); if(!dragging||dragging===li) return;
      const rect=li.getBoundingClientRect(); const before=e.clientY<rect.top+rect.height/2;
      listEl.insertBefore(dragging,before?li:li.nextSibling);
    });

    return li;
  }

  function toModel(){
    const items=[]; for(const li of listEl.querySelectorAll(".item")){
      const url=li.querySelector(".u").value.trim(); if(!url) continue;
      items.push(parseItem(url, li.querySelector(".opt").value.trim()));
    } return items;
  }
  function fromModel(items){ listEl.innerHTML=""; (items||[]).forEach(it=> listEl.appendChild(createItem(it.src, itemToOptString(it)))); }

  // Inspector
  const ins={
    root:document.getElementById("inspector"), url:document.getElementById("insUrl"),
    apply:document.getElementById("applyItem"), preview:document.getElementById("previewItem"), clear:document.getElementById("clearItem"),
    seconds:i_seconds, loop:i_loop, maxSeconds:i_maxSeconds, fit:i_fit, scale:i_scale, rotDeg:i_rotDeg, txPct:i_txPct, tyPct:i_tyPct
  };
  function clearInspector(){ if(selectedLi) selectedLi.classList.remove("selected"); selectedLi=null; ins.root.style.display="none"; }
  function loadInspectorFromLi(li){
    const url=li.querySelector(".u").value.trim(); const it=parseItem(url, li.querySelector(".opt").value.trim());
    ins.url.textContent=url||"(no url)";
    ins.seconds.value = it.type==="image" ? (it.seconds||0) : 0;
    ins.loop.value    = (typeof it.loop==="boolean")?String(it.loop):"inherit";
    ins.maxSeconds.value=it.maxSeconds||0; ins.fit.value = it.fit?it.fit:"inherit";
    ins.scale.value   = (it.scale!=null)?Math.round(it.scale*100):"";
    ins.rotDeg.value  = (it.rotDeg!=null)?it.rotDeg:"";
    ins.txPct.value   = (it.txPct!=null)?it.txPct:"";
    ins.tyPct.value   = (it.tyPct!=null)?it.tyPct:"";
  }
  function writeLiFromInspector(li){
    const url=li.querySelector(".u").value.trim(); if(!url) return alert("URL required.");
    const type=inferType(url); const it=parseItem(url, li.querySelector(".opt").value.trim()); it.type=type;
    const s=parseInt(ins.seconds.value||"0",10); if(type==="image"){ if(s>0) it.seconds=s; else delete it.seconds; } else delete it.seconds;
    if(type==="video"){ const ms=parseInt(ins.maxSeconds.value||"0",10); if(ms>0) it.maxSeconds=ms; else delete it.maxSeconds; if(ins.loop.value==="true") it.loop=true; else if(ins.loop.value==="false") it.loop=false; else delete it.loop; } else { delete it.loop; delete it.maxSeconds; }
    const fit=ins.fit.value; if(fit==="contain"||fit==="cover") it.fit=fit; else delete it.fit;
    const z=ins.scale.value.trim(); if(z!==""){ it.scale=clamp(parseInt(z,10)/100,0.01,5);} else delete it.scale;
    ["rotDeg","txPct","tyPct"].forEach(k=>{ const v=ins[k].value.trim(); if(v!=="") it[k]=parseInt(v,10); else delete it[k]; });
    li.querySelector(".opt").value=itemToOptString(it);
  }
  function selectLi(li){
    if(selectedLi) selectedLi.classList.remove("selected"); selectedLi=li; li.classList.add("selected"); ins.root.style.display="block"; loadInspectorFromLi(li);
    maybeAutoPreviewOnSelect(li);
  }
  function maybeAutoPreviewOnSelect(li){ if(editModeEl.checked && li) sendLivePreviewForLi(li); }

  ins.apply.addEventListener("click",()=>{ if(!selectedLi) return; writeLiFromInspector(selectedLi); loadInspectorFromLi(selectedLi); if(editModeEl.checked) sendLivePreviewForLi(selectedLi); });
  ins.clear.addEventListener("click",()=>{ if(!selectedLi) return; selectedLi.querySelector(".opt").value=""; loadInspectorFromLi(selectedLi); if(editModeEl.checked) sendLivePreviewForLi(selectedLi); });

  // Live preview on inspector field changes (debounced)
  ["seconds","loop","maxSeconds","fit","scale","rotDeg","txPct","tyPct"].forEach(k=>{
    ins[k].addEventListener("input", debounce(()=>{ if(!selectedLi) return; writeLiFromInspector(selectedLi); if(editModeEl.checked) sendLivePreviewForLi(selectedLi); }, 150));
  });

  // Globals
  const els={interval,videoMax,fit,bg,shape,pad,padVal,ringW,ringC,scale,scaleVal,rot,rotVal,tx,txVal,ty,tyVal,useBox,boxPx,boxComp};
  ["pad","scale","rot","tx","ty","boxComp"].forEach(id=>{
    document.getElementById(id).addEventListener("input",()=>{
      if(id==="pad") padVal.textContent=pad.value;
      if(id==="scale") scaleVal.textContent=scale.value;
      if(id==="rot") rotVal.textContent=rot.value;
      if(id==="tx") txVal.textContent=tx.value;
      if(id==="ty") tyVal.textContent=ty.value;
      if(editModeEl.checked && selectedLi){ // live preview current item if globals change
        sendLivePreviewForLi(selectedLi);
      }
    });
  });
  function readGlobals(){ return {
    interval:Math.max(1,parseInt(els.interval.value||"30",10)),
    videoMax:Math.max(0,parseInt(els.videoMax.value||"0",10)),
    fit:els.fit.value, bg:els.bg.value||"#000000", shape:els.shape.value, padPct:parseInt(els.pad.value,10),
    ringW:parseInt(els.ringW.value||"0",10), ringC:els.ringC.value||"#222222",
    scale:Math.max(0.01,(parseInt(els.scale.value,10)||100)/100), rotDeg:parseInt(els.rot.value,10)||0,
    txPct:parseInt(els.tx.value,10)||0, tyPct:parseInt(els.ty.value,10)||0,
    useBox:!!els.useBox.checked, boxPx:Math.max(100,parseInt(els.boxPx.value||"640",10)), boxComp:Math.max(50,parseInt(els.boxComp.value||"100",10))
  };}
  function writeGlobals(o){
    els.interval.value=o.interval??30; els.videoMax.value=o.videoMax??0; els.fit.value=o.fit||"contain"; els.bg.value=o.bg||"#000000";
    els.shape.value=o.shape||"circle"; els.pad.value=o.padPct??4; els.padVal.textContent=els.pad.value;
    els.ringW.value=o.ringW??0; els.ringC.value=o.ringC||"#222222";
    els.scale.value=Math.round((o.scale??1)*100); els.scaleVal.textContent=els.scale.value;
    els.rot.value=o.rotDeg??0; els.rotVal.textContent=els.rot.value;
    els.tx.value=o.txPct??0; els.txVal.textContent=els.tx.value;
    els.ty.value=o.tyPct??0; els.tyVal.textContent=els.ty.value;
    els.useBox.checked=(o.useBox!==false); els.boxPx.value=o.boxPx??640; els.boxComp.value=o.boxComp??100;
  }

  // Save/Load/Clear
  document.getElementById("save").addEventListener("click",()=>{
    localStorage.setItem(K_PLAYLIST, JSON.stringify(toModel()));
    localStorage.setItem(K_OPTIONS, JSON.stringify(readGlobals()));
    // Exit edit mode on device and restart from item 1
    sendCommand({type:"exitEditAndRestart"});
    editModeEl.checked=false;
    alert("Saved. Device will restart the playlist from item 1.");
  });
  document.getElementById("load").addEventListener("click",()=>{
    const items=JSON.parse(localStorage.getItem(K_PLAYLIST)||"[]");
    const opts =JSON.parse(localStorage.getItem(K_OPTIONS)||"{}");
    fromModel(items); writeGlobals(opts);
    if(!items.length){
      const demo=`https://www.gstatic.com/webp/gallery/1.webp
https://media.giphy.com/media/l0HlQ7LRal8X9sWzO/giphy.gif
https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4 {"loop":false,"maxSeconds":6}`;
      const lines=demo.split(/\r?\n/).map(s=>s.trim());
      fromModel(lines.map(line=>{const m=line.match(/^(\S+)(?:\s+(\{.*\}))?$/); return parseItem(m[1],m[2]||"");}));
    }
  });
  document.getElementById("clear").addEventListener("click",()=>{ localStorage.removeItem(K_PLAYLIST); localStorage.removeItem(K_OPTIONS); fromModel([]); writeGlobals({}); document.getElementById("load").click(); });

  // Edit mode toggle: inform device
  editModeEl.addEventListener("change",()=> sendCommand({type:"setEditMode", value: !!editModeEl.checked}));

  // One-shot preview & live preview senders
  function sendPreviewForLi(li){
    const url=li.querySelector(".u").value.trim(); if(!url) return alert("URL required.");
    const it=parseItem(url, li.querySelector(".opt").value.trim());
    const opts=readGlobals();
    const payload={kind:"preview", ts:Date.now(), options:mergeOpts(opts,it), item:it, ttlMs:120000};
    try{ localStorage.setItem(K_PREVIEW, JSON.stringify(payload)); }catch{}
    postBC({type:"preview",payload});
  }
  function sendLivePreviewForLi(li){
    const url=li.querySelector(".u").value.trim(); if(!url) return;
    const it=parseItem(url, li.querySelector(".opt").value.trim());
    const opts=readGlobals();
    const payload={kind:"preview", ts:Date.now(), options:mergeOpts(opts,it), item:it, ttlMs:120000, live:true};
    try{ localStorage.setItem(K_PREVIEW, JSON.stringify(payload)); }catch{}
    postBC({type:"preview",payload});
  }

  // Init
  document.getElementById("add").addEventListener("click",()=> listEl.appendChild(createItem()));
  document.getElementById("exportTxt").addEventListener("click",()=>{
    const text=toModel().map(it=> it.src + (itemToOptString(it)?(" "+itemToOptString(it)):"")).join("\n");
    navigator.clipboard.writeText(text).catch(()=>{}); alert("Copied playlist text to clipboard.");
  });
  document.getElementById("config").style.display="block";
  document.getElementById("load").click();
}

/* =================================================================
   DEVICE MODE (kraken=1)
================================================================= */
if(isKraken){
  const stage=player, box=box, imgEl=imgEl, vidEl=vidEl;
  stage.style.display="flex";

  let items = JSON.parse(localStorage.getItem(K_PLAYLIST)||"[]");
  let o = Object.assign(
    {interval:30,videoMax:0,fit:"contain",bg:"#000000",shape:"circle",padPct:4,ringW:0,ringC:"#222",
     scale:1,rotDeg:0,txPct:0,tyPct:0,useBox:true,boxPx:640,boxComp:100},
    JSON.parse(localStorage.getItem(K_OPTIONS)||"{}")
  );
  let idx=0, timer=null, previewActive=false, lastPreviewTs=0, editMode=false;

  function updateBoxScale(){
    stage.style.background=o.bg||"#000"; box.style.setProperty('--boxPx', o.boxPx+'px');
    const vw=stage.clientWidth, vh=stage.clientHeight;
    const scale = o.useBox ? (Math.min(vw,vh)/o.boxPx)*(o.boxComp/100) : 1;
    box.style.setProperty('--boxScale', scale);
    box.classList.toggle('circle', o.shape==='circle');
  }
  window.addEventListener("resize", updateBoxScale);

  if(!items.length){
    localStorage.setItem(K_PLAYLIST, JSON.stringify([
      {src:"https://www.gstatic.com/webp/gallery/1.webp",type:"image"},
      {src:"https://media.giphy.com/media/l0HlQ7LRal8X9sWzO/giphy.gif",type:"image"},
      {src:"https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4",type:"video",loop:false}
    ])); location.reload();
  }

  const clearTimer=()=>{ if(timer){ clearTimeout(timer); timer=null; } };

  function showImage(src, seconds, opts){
    clearTimer(); applyVisual(box,imgEl,vidEl,opts||o);
    vidEl.pause(); vidEl.removeAttribute('src'); vidEl.load(); vidEl.classList.remove('show');
    imgEl.src=src; imgEl.classList.add('show');
    if(editMode){ /* hold */ } else {
      const s=Math.max(1, seconds || (opts?.interval ?? o.interval) || 30);
      timer=setTimeout(next, s*1000);
    }
  }
  function showVideo(src, entry, opts){
    clearTimer(); applyVisual(box,imgEl,vidEl,opts||o);
    imgEl.classList.remove('show');
    const maxSeconds=(opts?.videoMax||0) || entry.maxSeconds || 0;
    const loop = editMode ? true : ((entry.loop===true) && !maxSeconds);
    vidEl.loop=loop; vidEl.muted=true; vidEl.controls=false; vidEl.autoplay=true;
    vidEl.src=src; vidEl.classList.add('show');
    const p=vidEl.play(); if(p&&p.catch) p.catch(()=>setTimeout(()=>vidEl.play().catch(()=>{}),250));
    function advance(){ vidEl.removeEventListener('ended', advance); next(); }
    if(!editMode){
      if(maxSeconds) timer=setTimeout(advance, Math.max(1,maxSeconds)*1000);
      else if(!vidEl.loop) vidEl.addEventListener('ended', advance, {once:true});
      else if(opts?.interval||o.interval) timer=setTimeout(advance, Math.max(1,(opts?.interval||o.interval))*1000);
    }
  }

  function render(){
    updateBoxScale();
    box.style.setProperty('--pad',(o.padPct||0)+'%');
    const it=items[idx]; if(!it) return;
    const eff=mergeOpts(o,it);
    imgEl.classList.remove('fade'); vidEl.classList.remove('fade'); void imgEl.offsetWidth; void vidEl.offsetWidth;
    imgEl.classList.add('fade'); vidEl.classList.add('fade');
    if(it.type==='video') showVideo(it.src,it,eff); else showImage(it.src,it.seconds,eff);
  }
  function next(){
    if(previewActive){ previewActive=false; }
    idx=(idx+1)%items.length; render();
  }
  render();

  // Receive previews/commands
  function tryActivatePreview(raw){
    if(!raw) return; let payload; try{payload=JSON.parse(raw)}catch{return}
    if(!payload||payload.kind!=="preview") return;
    if(payload.ts<=lastPreviewTs) return;
    if(payload.ttlMs && (Date.now()-payload.ts>payload.ttlMs)) return;
    lastPreviewTs=payload.ts; previewActive=true; clearTimer();
    const it=payload.item; const opts=payload.options||o;
    imgEl.classList.remove('fade'); vidEl.classList.remove('fade'); void imgEl.offsetWidth; void vidEl.offsetWidth;
    imgEl.classList.add('fade'); vidEl.classList.add('fade');
    updateBoxScale();
    if(inferType(it.src)==="video") showVideo(it.src,it,opts); else showImage(it.src,it.seconds,opts);
  }
  function handleCommand(raw){
    if(!raw) return; let cmd; try{cmd=JSON.parse(raw)}catch{return}
    if(cmd.type==="setEditMode"){ editMode=!!cmd.value; }
    if(cmd.type==="exitEditAndRestart"){
      editMode=false; previewActive=false; clearTimer();
      // reload latest saved playlist & options and start from item 1
      items=JSON.parse(localStorage.getItem(K_PLAYLIST)||"[]")||items;
      o = Object.assign(
        {interval:30,videoMax:0,fit:"contain",bg:"#000000",shape:"circle",padPct:4,ringW:0,ringC:"#222",
         scale:1,rotDeg:0,txPct:0,tyPct:0,useBox:true,boxPx:640,boxComp:100},
        JSON.parse(localStorage.getItem(K_OPTIONS)||"{}")
      );
      idx=0; render();
    }
  }

  window.addEventListener("storage",(e)=>{
    if(e.key===K_PREVIEW && e.newValue) tryActivatePreview(e.newValue);
    if(e.key===K_CMD && e.newValue) handleCommand(e.newValue);
    if(!editMode && e.key===K_OPTIONS){
      o = Object.assign(
        {interval:30,videoMax:0,fit:"contain",bg:"#000000",shape:"circle",padPct:4,ringW:0,ringC:"#222",
         scale:1,rotDeg:0,txPct:0,tyPct:0,useBox:true,boxPx:640,boxComp:100},
        JSON.parse(localStorage.getItem(K_OPTIONS)||"{}")
      ); render();
    }
    if(!editMode && e.key===K_PLAYLIST){
      items=JSON.parse(localStorage.getItem(K_PLAYLIST)||"[]")||items;
    }
  });

  // BroadcastChannel listeners
  try{
    const bc=new BroadcastChannel("krakenChannel");
    bc.onmessage=(ev)=>{
      if(ev?.data?.type==="preview" && ev.data.payload) tryActivatePreview(JSON.stringify(ev.data.payload));
      if(ev?.data?.type==="cmd" && ev.data.payload) handleCommand(JSON.stringify(ev.data.payload));
    };
  }catch{}
  // pick up any recent preview or cmd
  tryActivatePreview(localStorage.getItem(K_PREVIEW));
  handleCommand(localStorage.getItem(K_CMD));
}

/* ===== small utils ===== */
function postBC(msg){ try{ const bc=new BroadcastChannel("krakenChannel"); bc.postMessage(msg); setTimeout(()=>bc.close(),200);}catch{} }
function sendCommand(payload){ try{ localStorage.setItem(K_CMD, JSON.stringify(payload)); }catch{} postBC({type:"cmd",payload}); }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }
</script>
</body>
</html>
